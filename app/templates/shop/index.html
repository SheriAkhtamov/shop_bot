{% extends "shop/base.html" %}

{% block content %}
<!-- –®–∞–ø–∫–∞: –ü–æ–∏—Å–∫ –∏ –Ø–∑—ã–∫ -->
<div class="sticky top-0 bg-[#F2E8DC]/90 backdrop-blur-md z-30 px-5 py-4 border-b border-white/20">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-2xl font-extrabold text-[#3E2310] tracking-tight">Caffeine.</h1>
            <p class="text-xs text-[#8C735F] font-medium">–°–≤–µ–∂–µ—Å—Ç—å –≤ –∫–∞–∂–¥–æ–π –¥–µ—Ç–∞–ª–∏</p>
        </div>
        <div class="flex space-x-3 text-sm font-bold bg-white/40 p-1.5 rounded-lg">
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
            <a href="/shop/set_lang?lang=ru"
                class="px-2 rounded-md transition {% if user.language == 'ru' %}bg-[#6B3F1E] text-white shadow-sm{% else %}text-[#8C735F] hover:text-[#6B3F1E]{% endif %}">RU</a>
            <a href="/shop/set_lang?lang=uz"
                class="px-2 rounded-md transition {% if user.language == 'uz' %}bg-[#6B3F1E] text-white shadow-sm{% else %}text-[#8C735F] hover:text-[#6B3F1E]{% endif %}">UZ</a>
        </div>
    </div>

    <div class="relative">
        <i class="fas fa-search absolute left-4 top-3.5 text-[#8C735F]"></i>
        <input type="text" oninput="searchProducts(this.value)"
            placeholder="{% if user.language == 'ru' %}–ù–∞–π—Ç–∏ –∫–æ—Ñ–µ...{% else %}Qahva qidirish...{% endif %}"
            class="w-full bg-white/60 border border-[#E0CCB7] rounded-xl pl-11 pr-4 py-3 text-[#3E2310] placeholder-[#B09B8B] focus:outline-none focus:ring-2 focus:ring-[#6B3F1E]/20 focus:bg-white transition-all shadow-sm">
    </div>
</div>

<!-- –ü—Ä–æ–º–æ-–±–ª–æ–∫ -->
<div class="mt-6 px-5">
    <div class="promo-card">
        <div>
            <p class="text-xs uppercase tracking-widest text-[#D6C0AD] font-bold">–ù–æ–≤–∏–Ω–∫–∞ –Ω–µ–¥–µ–ª–∏</p>
            <h2 class="text-2xl font-extrabold text-white mt-2">Caramel Cloud</h2>
            <p class="text-sm text-white/80 mt-1">–õ–µ–≥–∫–∏–π, –º—è–≥–∫–∏–π –∏ –±–∞—Ä—Ö–∞—Ç–Ω—ã–π –≤–∫—É—Å.</p>
        </div>
        <div class="promo-badge">-15%</div>
    </div>
    <div class="mt-4 grid grid-cols-3 gap-2 text-center text-[11px] font-bold text-[#3E2310]">
        <div class="info-pill">‚è± 15-20 –º–∏–Ω</div>
        <div class="info-pill">üåø 100% –∞—Ä–∞–±–∏–∫–∞</div>
        <div class="info-pill">‚≠ê 4.9/5</div>
    </div>
</div>

<!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª) -->
<div id="categories" class="mt-6 pl-5 scroll-mt-32">
    <div class="flex overflow-x-auto space-x-3 hide-scroll pb-2 pr-5">
        <button
            class="bg-[#6B3F1E] text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-coffee active:scale-95 transition-transform"
            data-id="all" onclick="filterByCategory('all')">
            ‚òï –í—Å–µ
        </button>
        {% for cat in categories %}
        <button
            class="bg-transparent border-2 border-[#E0CCB7] text-[#8C735F] px-5 py-2.5 rounded-full text-sm font-bold whitespace-nowrap active:bg-[#6B3F1E] active:text-white active:border-[#6B3F1E] transition-colors"
            data-id="{{ cat.id }}" onclick="filterByCategory('{{ cat.id }}')">
            {{ cat.name_ru if user.language == 'ru' else cat.name_uz }}
        </button>
        {% endfor %}
    </div>
</div>

<!-- –ö–∞—Ä—É—Å–µ–ª—å —Ç–æ–≤–∞—Ä–æ–≤ (–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ) -->
<div class="mt-8 px-5">
    <div class="flex justify-between items-end mb-4">
        <h2 class="text-xl font-extrabold text-[#3E2310]">üî• –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</h2>
        <span class="text-xs text-[#8C735F] font-semibold tracking-wide uppercase">Top Picks</span>
    </div>
    <div class="flex overflow-x-auto space-x-4 hide-scroll pb-6 -mx-5 px-5">
        {% for product in products[:5] %}
        {% set product_name = product.name_ru if user.language == 'ru' else product.name_uz %}
        {% set product_desc = product.description_ru if user.language == 'ru' else product.description_uz %}
        <div class="min-w-[160px] bg-white rounded-2xl shadow-coffee p-3 active:scale-95 transition-transform duration-200"
            onclick="openProductModal('{{ product.id }}', '{{ product_name | e }}', '{{ product_desc | default('', true) | e }}', '{{ product.price }}', '{{ product.image_path }}', '{{ product.stock }}')">
            <div
                class="bg-[#F9F9F9] rounded-xl p-2 mb-3 h-32 flex items-center justify-center relative overflow-hidden">
                {% if product.image_path %}
                <img src="{{ product.image_path }}" class="w-full h-full object-contain mix-blend-multiply">
                {% else %}
                <div class="text-[#D6C0AD] text-4xl opacity-50">
                    <i class="fas fa-coffee"></i>
                </div>
                {% endif %}
            </div>
            <h3 class="text-sm font-bold text-[#3E2310] truncate">{{ product_name }}</h3>
            <p class="text-[#6B3F1E] font-extrabold text-sm mt-1">{{ product.price }} —Å—É–º</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –°–µ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="mt-2 px-5 pb-10">
    <h2 class="text-xl font-extrabold text-[#3E2310] mb-4">–ú–µ–Ω—é</h2>
    <div id="products-grid" class="grid grid-cols-2 gap-4">
        {% include "shop/partials/product_list.html" %}
    </div>
</div>

<!-- BOTTOM SHEET MODAL (–®—Ç–æ—Ä–∫–∞) -->
<div id="product-modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300" aria-modal="true">
    <!-- Overlay -->
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeProductModal()"></div>

    <!-- Sheet -->
    <div class="absolute bottom-0 w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 translate-y-full"
        id="modal-sheet">
        <!-- Drag Handle -->
        <div class="w-full flex justify-center pt-3 pb-1" onclick="closeProductModal()">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <div class="p-6 pt-2">
            <div class="bg-[#F9F9F9] rounded-2xl p-6 mb-6 flex justify-center items-center h-48">
                <img id="modal-img" src="" class="h-full object-contain mix-blend-multiply drop-shadow-lg">
            </div>

            <div class="mb-6">
                <h2 id="modal-title" class="text-2xl font-extrabold text-[#3E2310] mb-2 leading-tight"></h2>
                <div class="flex items-center space-x-2 mb-3">
                <span id="modal-stock"
                        class="px-2 py-0.5 bg-[#dcfce7] text-[#16a34a] text-[10px] font-bold uppercase rounded-md tracking-wider">–í
                        –Ω–∞–ª–∏—á–∏–∏</span>
                </div>
                <p id="modal-desc" class="text-[#8C735F] text-sm leading-relaxed"></p>
            </div>

            <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
                <div>
                    <span class="text-xs text-[#8C735F] font-bold uppercase">–¶–µ–Ω–∞</span>
                    <p id="modal-price" class="text-2xl font-extrabold text-[#6B3F1E]"></p>
                </div>
                <button id="modal-add-btn"
                    class="bg-[#4f46e5] text-white px-8 py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-[#4f46e5]/30 active:scale-95 transition-transform flex items-center space-x-2">
                    <i class="fas fa-shopping-bag"></i>
                    <span>–í –∫–æ—Ä–∑–∏–Ω—É</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Animation for Bottom Sheet
    function openProductModal(id, name, desc, price, image, stock) {
        const modal = document.getElementById('product-modal');
        const sheet = document.getElementById('modal-sheet');

        // Fill data
        let imgEl = document.getElementById('modal-img');
        if (image) {
            imgEl.src = image;
            imgEl.style.display = 'block';
        } else {
            imgEl.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxIiBoZWlnaHQ9IjEiPjwvc3ZnPg==";
        }
        document.getElementById('modal-title').innerText = name;
        document.getElementById('modal-desc').innerText = desc || '';
        document.getElementById('modal-price').innerText = price + " —Å—É–º";

        let stockEl = document.getElementById('modal-stock');
        const addBtn = document.getElementById('modal-add-btn');
        if (stock > 0) {
            stockEl.innerText = "–í –Ω–∞–ª–∏—á–∏–∏";
            stockEl.className = "px-2 py-0.5 bg-[#E6F4EA] text-[#1E8E3E] text-[10px] font-bold uppercase rounded-md tracking-wider";
            addBtn.disabled = false;
            addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            stockEl.innerText = "–ù–µ—Ç";
            stockEl.className = "px-2 py-0.5 bg-red-100 text-red-600 text-[10px] font-bold uppercase rounded-md tracking-wider";
            addBtn.disabled = true;
            addBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        addBtn.onclick = () => {
            if (stock > 0) {
                addToCart(id);
                closeProductModal();
            }
        };

        // Show
        modal.classList.remove('hidden');
        // Small delay to allow display:block to apply before transform
        setTimeout(() => {
            sheet.classList.remove('translate-y-full');
        }, 10);

        tg.HapticFeedback.impactOccurred('medium');
    }

    function closeProductModal() {
        const modal = document.getElementById('product-modal');
        const sheet = document.getElementById('modal-sheet');

        sheet.classList.add('translate-y-full');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300); // Wait for transition
    }

</script>
{% endblock %}
