<!DOCTYPE html>
<html>
<head>
    <title>Loading...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #f3f4f6; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;}
        .error { color: #ef4444; text-align: center; padding: 20px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader" class="loader"></div>
    <div id="error-msg" class="error">
        <p>Ошибка авторизации.</p>
        <p>Попробуйте перезапустить бота.</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Функция авторизации
        async function authorize() {
            try {
                // Если нет initData, мы не в Telegram
                if (!tg.initData) {
                    throw new Error("No initData");
                }

                // Отправляем данные на сервер
                const response = await fetch('/shop/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'initData=' + encodeURIComponent(tg.initData)
                });

                if (response.ok) {
                    // Успех! Перезагружаем страницу, чтобы сервер увидел установленную куку
                    window.location.reload();
                } else {
                    throw new Error("Auth failed");
                }
            } catch (e) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
                console.error(e);
            }
        }

        // Запускаем
        authorize();
    </script>
</body>
</html>