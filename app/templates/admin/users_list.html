{% extends "admin/base.html" %}

{% block header %}–ö–ª–∏–µ–Ω—Ç—ã{% endblock %}

{% block content %}
<div class="bg-white rounded px-8 pt-6 pb-8 mb-4">
    <h4 class="font-bold mb-4">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
    <form action="/admin/users" method="GET" class="flex gap-4 items-end">
        <div class="flex-grow">
            <label class="block text-gray-700 text-xs font-bold mb-2">–ò–º—è –∏–ª–∏ –¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input name="q" type="text" value="{{ request.query_params.get('q', '') }}" 
                   class="border rounded w-full py-2 px-3 text-gray-700" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ –Ω–æ–º–µ—Ä...">
        </div>
        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" type="submit">
            –ù–∞–π—Ç–∏
        </button>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ -->
<div class="bg-white shadow-md rounded my-6 overflow-x-auto">
    <table class="min-w-full table-auto">
        <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <th class="py-3 px-6 text-left">ID</th>
                <th class="py-3 px-6 text-left">–ö–ª–∏–µ–Ω—Ç</th>
                <th class="py-3 px-6 text-left">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th class="py-3 px-6 text-center">–î–æ–ª–≥ (—Å—É–º)</th>
                <th class="py-3 px-6 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody class="text-gray-600 text-sm font-light">
            {% for user in users %}
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left">{{ user.id }}</td>
                <td class="py-3 px-6 text-left">
                    <div class="flex items-center">
                        <span class="font-medium">{{ user.username or "–ë–µ–∑ –∏–º–µ–Ω–∏" }}</span>
                    </div>
                </td>
                <td class="py-3 px-6 text-left">{{ user.phone or "-" }}</td>
                <td class="py-3 px-6 text-center">
                    {% if user.debt > 0 %}
                    <span class="bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs font-bold">
                        {{ user.debt }}
                    </span>
                    {% else %}
                    <span class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">–ù–µ—Ç –¥–æ–ª–≥–æ–≤</span>
                    {% endif %}
                </td>
                <td class="py-3 px-6 text-center">
                    <button onclick="openDebtModal('{{ user.id }}', '{{ user.username or '' }}', '{{ user.debt }}')" 
                            class="text-blue-500 hover:text-blue-700 font-bold border border-blue-500 rounded px-3 py-1 text-xs hover:bg-blue-50">
                        üí∞ –£–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–ª–≥–æ–º
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if not users %}
    <div class="p-6 text-center text-gray-500">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="debtModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full" style="z-index: 50;">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–æ–º</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500 mb-4">
                    –£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –¥–æ–ª–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <b id="modalUser"></b>.
                    –ï—Å–ª–∏ –≤–≤–µ—Å—Ç–∏ 0 ‚Äî –¥–æ–ª–≥ –±—É–¥–µ—Ç —Å–Ω—è—Ç.
                </p>
                <form id="debtForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="number" name="amount" id="debtAmount" 
                           class="border rounded w-full py-2 px-3 text-gray-700 mb-4" 
                           placeholder="–°—É–º–º–∞ (—Å—É–º)" required min="0">
                    
                    <div class="items-center px-4 py-3">
                        <button id="okBtn" type="submit"
                            class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button type="button" onclick="closeDebtModal()"
                            class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openDebtModal(userId, username, currentDebt) {
        document.getElementById('debtModal').classList.remove('hidden');
        document.getElementById('modalUser').innerText = username;
        document.getElementById('debtAmount').value = currentDebt;
        document.getElementById('debtForm').action = "/admin/users/" + userId + "/set_debt";
    }

    function closeDebtModal() {
        document.getElementById('debtModal').classList.add('hidden');
    }
    
    // Close modal on outside click
    window.onclick = function(event) {
        var modal = document.getElementById('debtModal');
        if (event.target == modal) {
            closeDebtModal();
        }
    }
</script>
{% endblock %}
