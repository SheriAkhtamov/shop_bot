{% extends "admin/base.html" %}

{% block header %}–ö–ª–∏–µ–Ω—Ç—ã{% endblock %}

{% block content %}
<div class="glass-card rounded-2xl p-6 mb-6">
    <h4 class="font-bold mb-4 text-[#3E2310]">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
    <form action="/admin/users" method="GET" class="flex flex-col xl:flex-row gap-4 items-end">
        <div class="flex-grow">
            <label class="block text-gray-500 text-xs font-bold mb-2">–ò–º—è, ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</label>
            <input name="q" type="text" value="{{ filters.q }}" 
                   class="border border-[#E0CCB7] rounded-xl w-full py-2 px-3 text-gray-700" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, ID –∏–ª–∏ –Ω–æ–º–µ—Ä...">
        </div>
        <div>
            <label class="block text-gray-500 text-xs font-bold mb-2">–î–æ–ª–≥–∏</label>
            <select name="debt" class="border border-[#E0CCB7] rounded-xl py-2 px-3 text-gray-700">
                <option value="all" {% if filters.debt == 'all' %}selected{% endif %}>–í—Å–µ</option>
                <option value="with" {% if filters.debt == 'with' %}selected{% endif %}>–° –¥–æ–ª–≥–æ–º</option>
                <option value="without" {% if filters.debt == 'without' %}selected{% endif %}>–ë–µ–∑ –¥–æ–ª–≥–∞</option>
            </select>
        </div>
        <button class="bg-[#3E2310] hover:bg-[#543116] text-white font-bold py-2 px-4 rounded-xl" type="submit">
            –ù–∞–π—Ç–∏
        </button>
        <a href="/admin/users" class="text-sm font-semibold text-[#6B3F1E] hover:text-[#543116]">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ -->
<div class="bg-white shadow-coffee rounded-2xl my-6 overflow-x-auto glass-card">
    <table class="min-w-full table-auto">
        <thead>
            <tr class="bg-[#EFE6DB] text-[#3E2310] uppercase text-sm leading-normal font-bold">
                <th class="py-3 px-6 text-left">ID</th>
                <th class="py-3 px-6 text-left">–ö–ª–∏–µ–Ω—Ç</th>
                <th class="py-3 px-6 text-left">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th class="py-3 px-6 text-center">–î–æ–ª–≥ (—Å—É–º)</th>
                <th class="py-3 px-6 text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody class="text-gray-700 text-sm font-medium">
            {% for user in users %}
            <tr class="border-b border-[#EFE6DB] hover:bg-[#F9F4EF]">
                <td class="py-3 px-6 text-left">{{ user.id }}</td>
                <td class="py-3 px-6 text-left">
                    <div class="flex items-center">
                        <span class="font-medium">{{ user.username or "–ë–µ–∑ –∏–º–µ–Ω–∏" }}</span>
                    </div>
                </td>
                <td class="py-3 px-6 text-left">{{ user.phone or "-" }}</td>
                <td class="py-3 px-6 text-center">
                    {% if user.debt > 0 %}
                    <span class="bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs font-bold">
                        {{ user.debt }}
                    </span>
                    {% else %}
                    <span class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">–ù–µ—Ç –¥–æ–ª–≥–æ–≤</span>
                    {% endif %}
                </td>
                <td class="py-3 px-6 text-center">
                    <button onclick='openDebtModal({{ user.id|tojson }}, {{ (user.username or "")|tojson }}, {{ (user.debt or 0)|tojson }})' 
                            class="text-[#3E2310] hover:text-[#543116] font-bold border border-[#E0CCB7] rounded-xl px-3 py-1 text-xs hover:bg-[#F2E8DC]">
                        üí∞ –£–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–ª–≥–æ–º
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if not users %}
    <div class="p-6 text-center text-gray-500">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="debtModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full" style="z-index: 50;">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–æ–º</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500 mb-4">
                    –£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –¥–æ–ª–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <b id="modalUser"></b>.
                    –ï—Å–ª–∏ –≤–≤–µ—Å—Ç–∏ 0 ‚Äî –¥–æ–ª–≥ –±—É–¥–µ—Ç —Å–Ω—è—Ç.
                </p>
                <form id="debtForm" method="POST" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="number" name="amount" id="debtAmount" 
                           class="border rounded w-full py-2 px-3 text-gray-700 mb-4" 
                           placeholder="–°—É–º–º–∞ (—Å—É–º)" required min="0">
                    
                    <div class="items-center px-4 py-3">
                        <button id="okBtn" type="submit"
                            class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button type="button" onclick="closeDebtModal()"
                            class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openDebtModal(userId, username, currentDebt) {
        document.getElementById('debtModal').classList.remove('hidden');
        document.getElementById('modalUser').innerText = username;
        document.getElementById('debtAmount').value = currentDebt;
        document.getElementById('debtForm').action = "/admin/users/" + userId + "/set_debt";
    }

    function closeDebtModal() {
        document.getElementById('debtModal').classList.add('hidden');
    }
    
    // Close modal on outside click
    window.onclick = function(event) {
        var modal = document.getElementById('debtModal');
        if (event.target == modal) {
            closeDebtModal();
        }
    }
</script>
{% endblock %}
