{% extends "admin/base.html" %}

{% block header %}–î–∞—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
    <!-- Card 1: Users -->
    <div class="admin-card p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-2xl bg-[#ede9fe] text-[#5b3df5]">
                <i class="fas fa-users fa-2x"></i>
            </div>
            <div class="ml-4">
                <p class="mb-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>
                <p class="text-3xl font-bold text-[#0f172a]">{{ users_count }}</p>
            </div>
        </div>
    </div>

    <!-- Card 2: Orders Today -->
    <div class="admin-card p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-2xl bg-[#e0f2fe] text-[#0284c7]">
                <i class="fas fa-shopping-bag fa-2x"></i>
            </div>
            <div class="ml-4">
                <p class="mb-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</p>
                <p class="text-3xl font-bold text-[#0f172a]">{{ orders_today }}</p>
            </div>
        </div>
    </div>

    <!-- Card 3: Revenue Month -->
    <div class="admin-card p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-2xl bg-[#dcfce7] text-[#16a34a]">
                <i class="fas fa-money-bill-wave fa-2x"></i>
            </div>
            <div class="ml-4">
                <p class="mb-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">–í—ã—Ä—É—á–∫–∞ (–º–µ—Å)</p>
                <p class="text-2xl font-bold text-[#0f172a]">{{ revenue_month }} <span
                        class="text-sm text-gray-400">—Å—É–º</span></p>
            </div>
        </div>
    </div>

    <!-- Card 4: Total Debt -->
    <div class="admin-card p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-2xl bg-[#fee2e2] text-[#ef4444]">
                <i class="fas fa-hand-holding-usd fa-2x"></i>
            </div>
            <div class="ml-4">
                <p class="mb-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">–û–±—â–∏–π –¥–æ–ª–≥</p>
                <p class="text-2xl font-bold text-red-600">{{ total_debt }} <span
                        class="text-sm text-gray-400">—Å—É–º</span></p>
            </div>
        </div>
    </div>
    <!-- Card 5: Average Order -->
    <div class="admin-card p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-2xl bg-[#fef9c3] text-[#ca8a04]">
                <i class="fas fa-coins fa-2x"></i>
            </div>
            <div class="ml-4">
                <p class="mb-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</p>
                <p class="text-2xl font-bold text-[#0f172a]">{{ avg_order_value }} <span
                        class="text-sm text-gray-400">—Å—É–º</span></p>
            </div>
        </div>
    </div>

    <!-- Card 6: Repeat Customers -->
    <div class="admin-card p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-2xl bg-[#e0f2fe] text-[#0ea5e9]">
                <i class="fas fa-user-check fa-2x"></i>
            </div>
            <div class="ml-4">
                <p class="mb-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</p>
                <p class="text-3xl font-bold text-[#0f172a]">{{ repeat_customers }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

    <!-- Sales Dynamics -->
    <div class="admin-card p-6 lg:col-span-2">
        <h3 class="text-xl font-bold text-[#0f172a] mb-4">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h3>
        <div class="relative h-80">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- Top Products -->
    <div class="admin-card p-6">
        <h3 class="text-xl font-bold text-[#0f172a] mb-4">üèÜ –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <div class="relative h-64 flex justify-center">
            <canvas id="productsChart"></canvas>
        </div>
    </div>

    <!-- Payment Methods -->
    <div class="admin-card p-6">
        <h3 class="text-xl font-bold text-[#0f172a] mb-4">üí≥ –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</h3>
        <div class="relative h-64 flex justify-center">
            <canvas id="paymentChart"></canvas>
        </div>
    </div>

</div>

<!-- Insights & Actions -->
<div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
    <div class="glass-card rounded-2xl p-6 shadow-coffee bg-white xl:col-span-1">
        <h3 class="text-xl font-bold text-[#3E2310] mb-4">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div class="space-y-3">
            <a href="/admin/products/new"
                class="flex items-center justify-between bg-[#6B3F1E] text-white px-4 py-3 rounded-xl font-semibold shadow-lg hover:bg-[#543116] transition">
                <span>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</span>
                <i class="fas fa-plus"></i>
            </a>
            <a href="/admin/orders"
                class="flex items-center justify-between bg-[#EFE6DB] text-[#3E2310] px-4 py-3 rounded-xl font-semibold hover:bg-[#E5D7C8] transition">
                <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</span>
                <i class="fas fa-box-open"></i>
            </a>
            <a href="/admin/mailing"
                class="flex items-center justify-between bg-[#EFE6DB] text-[#3E2310] px-4 py-3 rounded-xl font-semibold hover:bg-[#E5D7C8] transition">
                <span>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</span>
                <i class="fas fa-paper-plane"></i>
            </a>
        </div>
        <div class="mt-6">
            <p class="text-xs uppercase text-gray-500 font-bold mb-2">–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</p>
            <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between bg-[#F9F4EF] rounded-lg px-3 py-2">
                    <span>–ù–æ–≤—ã–µ</span>
                    <span class="font-bold text-[#3E2310]">{{ status_counts.get('new', 0) }}</span>
                </div>
                <div class="flex items-center justify-between bg-[#F9F4EF] rounded-lg px-3 py-2">
                    <span>–í –ø—É—Ç–∏</span>
                    <span class="font-bold text-[#3E2310]">{{ status_counts.get('delivery', 0) }}</span>
                </div>
                <div class="flex items-center justify-between bg-[#F9F4EF] rounded-lg px-3 py-2">
                    <span>–ì–æ—Ç–æ–≤–æ</span>
                    <span class="font-bold text-[#3E2310]">{{ status_counts.get('done', 0) }}</span>
                </div>
                <div class="flex items-center justify-between bg-[#F9F4EF] rounded-lg px-3 py-2">
                    <span>–û–ø–ª–∞—á–µ–Ω–æ</span>
                    <span class="font-bold text-[#3E2310]">{{ status_counts.get('paid', 0) }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-card rounded-2xl p-6 shadow-coffee bg-white xl:col-span-2">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-[#3E2310]">üì¶ –ù–∏–∑–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏</h3>
            <a href="/admin/products?stock=low"
                class="text-sm font-semibold text-[#6B3F1E] hover:text-[#543116]">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</a>
        </div>
        {% if low_stock_products %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for product in low_stock_products %}
            <div class="flex items-center justify-between bg-[#F9F4EF] rounded-xl p-4">
                <div>
                    <p class="font-bold text-[#3E2310]">{{ product.name_ru }}</p>
                    <p class="text-xs text-gray-500">ID: {{ product.id }}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-bold text-red-600">{{ product.stock }} —à—Ç</p>
                    <a href="/admin/products/{{ product.id }}/edit"
                        class="text-xs text-[#6B3F1E] font-semibold">–û–±–Ω–æ–≤–∏—Ç—å</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-sm text-gray-500">–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ.</div>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    <div class="glass-card rounded-2xl p-6 shadow-coffee bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-[#3E2310]">üßæ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
            <a href="/admin/orders" class="text-sm font-semibold text-[#6B3F1E] hover:text-[#543116]">–í—Å–µ –∑–∞–∫–∞–∑—ã</a>
        </div>
        <div class="space-y-3">
            {% for order in recent_orders %}
            <div class="flex items-center justify-between bg-[#F9F4EF] rounded-xl px-4 py-3">
                <div>
                    <p class="font-bold text-[#3E2310]">#{{ order.id }} ¬∑ {{ order.user.username }}</p>
                    <p class="text-xs text-gray-500">{{ order.created_at | datetime_uz }}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-[#3E2310]">{{ order.total_amount }} —Å—É–º</p>
                    <a href="/admin/orders/{{ order.id }}"
                        class="text-xs text-[#6B3F1E] font-semibold">–û—Ç–∫—Ä—ã—Ç—å</a>
                </div>
            </div>
            {% else %}
            <div class="text-sm text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>
            {% endfor %}
        </div>
    </div>

    <div class="glass-card rounded-2xl p-6 shadow-coffee bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-[#3E2310]">üèÜ –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã</h3>
            <span class="text-xs font-semibold text-[#6B3F1E]">–ø–æ –≤—ã—Ä—É—á–∫–µ</span>
        </div>
        <div class="space-y-3">
            {% for customer, orders_count, total_spent in top_customers %}
            <div class="flex items-center justify-between bg-[#F9F4EF] rounded-xl px-4 py-3">
                <div>
                    <p class="font-bold text-[#3E2310]">{{ customer.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</p>
                    <p class="text-xs text-gray-500">{{ customer.phone or '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-[#3E2310]">{{ total_spent }} —Å—É–º</p>
                    <span class="text-xs text-gray-500">{{ orders_count }} –∑–∞–∫–∞–∑(–æ–≤)</span>
                </div>
            </div>
            {% else %}
            <div class="text-sm text-gray-500">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞.</div>
            {% endfor %}
        </div>
    </div>

    <div class="glass-card rounded-2xl p-6 shadow-coffee bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-[#3E2310]">üíº –¢–æ–ø –¥–æ–ª–∂–Ω–∏–∫–æ–≤</h3>
            <a href="/admin/users" class="text-sm font-semibold text-[#6B3F1E] hover:text-[#543116]">–ö–ª–∏–µ–Ω—Ç—ã</a>
        </div>
        <div class="space-y-3">
            {% for debtor in top_debtors %}
            <div class="flex items-center justify-between bg-[#F9F4EF] rounded-xl px-4 py-3">
                <div>
                    <p class="font-bold text-[#3E2310]">{{ debtor.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</p>
                    <p class="text-xs text-gray-500">{{ debtor.phone or '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-red-600">{{ debtor.debt }} —Å—É–º</p>
                    <a href="/admin/users" class="text-xs text-[#6B3F1E] font-semibold">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–ª–≥</a>
                </div>
            </div>
            {% else %}
            <div class="text-sm text-gray-500">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –¥–æ–ª–≥–∞–º–∏.</div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // --- Sales Chart ---
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels | tojson }},
        datasets: [
        {
            label: '–í—ã—Ä—É—á–∫–∞ (—Å—É–º)',
            data: {{ monthly_rev | tojson }},
        borderColor: '#6B3F1E',
        backgroundColor: 'rgba(107, 63, 30, 0.1)',
        yAxisID: 'y',
        borderWidth: 2,
        tension: 0.4,
        fill: true
                },
        {
            label: '–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤',
            data: {{ monthly_count | tojson }},
        borderColor: '#3B82F6',
        backgroundColor: 'transparent',
        yAxisID: 'y1',
        borderWidth: 2,
        borderDash: [5, 5],
        tension: 0.4,
        pointStyle: 'rectRounded'
                }
    ]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: '–°—É–º–º–∞' }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                title: { display: true, text: '–ö–æ–ª-–≤–æ' }
            }
        }
    }
    });

    // --- Top Products Chart ---
    const prodCtx = document.getElementById('productsChart').getContext('2d');
    new Chart(prodCtx, {
        type: 'doughnut',
        data: {
            labels: {{ top_prod_labels | tojson }},
        datasets: [{
            data: {{ top_prod_data | tojson }},
        backgroundColor: [
            '#6B3F1E', '#8B5A2B', '#A67B5B', '#C19A6B', '#DDBEA9'
        ],
        hoverOffset: 4
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' }
        }
    }
    });

    // --- Payment Methods Chart ---
    const payCtx = document.getElementById('paymentChart').getContext('2d');
    new Chart(payCtx, {
        type: 'pie',
        data: {
            labels: {{ pay_labels | tojson }},
        datasets: [{
            data: {{ pay_data | tojson }},
        backgroundColor: [
            '#10B981', '#F59E0B', '#EF4444' // Green, Yellow, Red
        ],
        hoverOffset: 4
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' }
        }
    }
    });
</script>
{% endblock %}
