{% extends "admin/base.html" %}

{% block header %}
{% if product %}Редактирование товара{% else %}Добавление товара{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl p-8 shadow-coffee glass-card">
        <form action="{% if product %}/admin/products/{{ product.id }}/edit{% else %}/admin/products/new{% endif %}"
            method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <script>
                const urlParams = new URLSearchParams(window.location.search);
                const error = urlParams.get('error');
                if (error === 'invalid_image') {
                    document.write(`
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-md flex items-center" role="alert">
                            <i class="fas fa-exclamation-triangle mr-3 text-xl"></i>
                            <div>
                                <p class="font-bold">Ошибка загрузки</p>
                                <p class="text-sm">Не удалось обработать изображение. Пожалуйста, попробуйте другой файл.</p>
                            </div>
                        </div>
                    `);
                }
            </script>

            <div class="-mx-3 md:flex mb-6">
                <div class="md:w-1/2 px-3 mb-6 md:mb-0">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Название (RU)
                    </label>
                    <input name="name_ru" value="{% if product %}{{ product.name_ru }}{% endif %}"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 mb-3 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        type="text" required placeholder="Например: Стакан 200мл">
                </div>
                <div class="md:w-1/2 px-3">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Nomlanishi (UZ)
                    </label>
                    <input name="name_uz" value="{% if product %}{{ product.name_uz }}{% endif %}"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        type="text" required placeholder="Masalan: Stakan 200ml">
                </div>
            </div>

            <div class="-mx-3 md:flex mb-6">
                <div class="md:w-1/2 px-3 mb-6 md:mb-0">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Категория
                    </label>
                    <div class="relative">
                        <select name="category_id"
                            class="block appearance-none w-full bg-[#F9F4EF] border border-[#D6C0AD] text-[#3E2310] py-3 px-4 pr-8 rounded-xl focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                            required>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if product and product.category_id==cat.id %}selected{%
                                endif %}>{{ cat.name_ru }}</option>
                            {% endfor %}
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[#3E2310]">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="md:w-1/4 px-3 mb-6 md:mb-0">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Цена (сум)
                    </label>
                    <input name="price" value="{% if product %}{{ product.price }}{% endif %}"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        type="number" required>
                </div>
                <div class="md:w-1/4 px-3">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Кол-во на складе
                    </label>
                    <input name="stock" value="{% if product %}{{ product.stock }}{% endif %}"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        type="number" required>
                </div>
            </div>

            <div class="-mx-3 md:flex mb-6">
                <div class="md:w-1/2 px-3 mb-6 md:mb-0">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        ИКПУ (mxik)
                    </label>
                    <input name="ikpu"
                        value="{% if product and product.ikpu %}{{ product.ikpu }}{% else %}00702001001000001{% endif %}"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        type="text" required placeholder="00702001001000001">
                </div>
                <div class="md:w-1/2 px-3">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Код упаковки
                    </label>
                    <input name="package_code"
                        value="{% if product and product.package_code %}{{ product.package_code }}{% else %}000000{% endif %}"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        type="text" required placeholder="000000">
                </div>
            </div>

            <div class="-mx-3 md:flex mb-6">
                <div class="md:w-full px-3">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Описание (RU)
                    </label>
                    <textarea name="description_ru"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 mb-3 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        rows="3">{% if product %}{{ product.description_ru }}{% endif %}</textarea>
                </div>
            </div>

            <div class="-mx-3 md:flex mb-6">
                <div class="md:w-full px-3">
                    <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                        Tavsif (UZ)
                    </label>
                    <textarea name="description_uz"
                        class="appearance-none block w-full bg-[#F9F4EF] text-[#3E2310] border border-[#D6C0AD] rounded-xl py-3 px-4 mb-3 focus:outline-none focus:bg-white focus:border-[#6B3F1E]"
                        rows="3">{% if product %}{{ product.description_uz }}{% endif %}</textarea>
                </div>
            </div>

            <div class="mb-8">
                <label class="block uppercase tracking-wide text-[#3E2310] text-xs font-bold mb-2 pl-1">
                    Фотография
                </label>
                {% if product and product.image_path %}
                <div class="mb-2">
                    <img src="{{ product.image_path }}"
                        class="h-24 w-24 rounded-xl object-cover border border-[#D6C0AD]">
                    <p class="text-xs text-gray-500 mt-1">Текущее изображение</p>
                </div>
                {% endif %}
                <div
                    class="relative border-2 border-dashed border-[#D6C0AD] rounded-xl bg-[#F9F4EF] hover:bg-white transition p-6 text-center group cursor-pointer">
                    <input type="file" name="image" accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <i
                        class="fas fa-cloud-upload-alt text-3xl text-[#D6C0AD] group-hover:text-[#6B3F1E] transition mb-2"></i>
                    <p class="text-sm text-[#3E2310]">Нажмите для загрузки или перетащите файл</p>
                </div>
            </div>

            <div class="flex items-center justify-end">
                <a href="/admin/products"
                    class="text-gray-500 hover:text-gray-700 font-bold py-3 px-6 mr-4 rounded-xl transition">
                    Отмена
                </a>
                <button
                    class="bg-[#6B3F1E] hover:bg-[#543116] text-white font-bold py-3 px-8 rounded-xl shadow-lg transition duration-300"
                    type="submit">
                    Сохранить товар
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
